<!DOCTYPE html>
<html lang="en">
    <head> 
        <meta name="author" content="stehrenberg, chanton1392, abstractCalculus, benjaminaaron">
        <title>Battleship AI</title> 

        <!-- vendors -->
        <script type="text/javascript" src="js/vendors/jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="js/vendors/jquery-ui.min.js"></script>
        <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
        
        <style></style> 
    </head> 
    <body>

        <!-- vendors css -->
        <link href="css/vendors/jquery-ui.min.css" rel="stylesheet"/>
        <!-- own css -->
        <link href="css/style.css" rel="stylesheet"/>
        <!-- own js -->
        <script type="text/javascript" src="js/player/AbstractPlayer.js"/></script>
        <script type="text/javascript" src="js/player/Human.js"/></script>
        <script type="text/javascript" src="js/player/AbstractBot.js"/></script>
        <script type="text/javascript" src="js/player/RandomBot.js"/></script>
        <script type="text/javascript" src="js/player/RandomDestroyerBot.js"/></script>
        <script type="text/javascript" src="js/game.js"></script>
        <script type="text/javascript" src="js/board.js"></script>
        <script type="text/javascript" src="js/AbstractField.js"></script>
        <script type="text/javascript" src="js/field.js"></script>
        <script type="text/javascript" src="js/ship.js"></script>

        <!-- <input type='button' value='debug' onclick='debug();'> -->

        <div id='gameHook'>
            <div id='gameControls'>
                    <select id='gameOptions' style="width:135px">
                        <option value='hb'>human vs. bot</option>
                        <option value='hh'>human vs. human</option>
                        <option value='bb'>bot vs. bot</option>
                        <option value='b'>single bot</option>
                        <option value='h'>single human</option>
                    </select>
                    <input type='button' id='startBtn' value='start game' onclick='initGame();'>
                    <input type='button' id='resetBtn' value='reset' onclick='reset();'>
                    <input type='button' id='infoBtn' value='info' onclick='info();'>
                    <input type='button' id='highscoreBtn' value='highscore' onclick='showHighscore();'>
                <div id='statusLabel'>enable javascript in your browser to play battleship&nbsp;&nbsp;&nbsp;</div>
            </div>
        </div>

        <div id='dialog' title='Highscore'>
            <table id='highscoreTable'>
                <tr><td>can't fetch data</td></tr>
            </table>
        </div>

        <script>

             $(function() {
                $('#dialog').dialog({
                    width: 800,
                    autoOpen: false,
                    show: {
                        effect: 'fade',
                        duration: 400
                    },
                    hide: {
                        effect: 'fade',
                        duration: 400
                    }
                });
            });

            $('#statusLabel').html('game hasn\'t started yet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;');
            $('#resetBtn').hide();

            var firebase = new Firebase('https://torrid-inferno-2196.firebaseio.com');  

            var game;

            function initGame(){

                var player0 = player1 = null;

                switch($('#gameOptions').val()){
                    case 'hb':
                        var name = prompt('Enter your name:', 'Max');
                        player0 = new Human(name);
                        player1 = new RandomDestroyerBot('random destroyer bot');                        
                        break;
                    case 'hh': 
                        var name = prompt('Enter the name of Player 1:', 'Max');
                        player0 = new Human(name);
                        name = prompt('Enter the name of Player 2:', 'Erika');
                        player1 = new Human(name);              
                        break;
                    case 'bb':
                        player0 = new RandomDestroyerBot('random destroyer bot 1');  
                        player1 = new RandomBot('random bot 2');
                        break;
                    case 'b':
                        player0 = new RandomBot('random bot');    
                        break;
                    case 'h':
                        var name = prompt('Enter your name:', 'Max');
                        player0 = new Human(name);
                        break;
                }
                $('#gameOptions').hide();
                $('#startBtn').hide();
                $('#resetBtn').show();
                $('#statusLabel').html('in <b>setup phase</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;');
                var gameControlsWidth = (player1 ? 2 : 1) * 370 + (player1 ? 4 : 0);
                $('#gameControls').css('cssText', 'width: ' + gameControlsWidth + 'px !important');

                var shipTypes = [new ShipType(5, 'aqua', 1), new ShipType(4, 'maroon', 1), new ShipType(3, 'lime', 1), new ShipType(2, 'orange', 2)];

                game = new Game(player0, player1, shipTypes, 10, 10, document.getElementById('gameHook'));
            }

            function draw(){
                window.requestAnimationFrame(drawGame);
            }

            function drawGame(){
                //console.log('drawing');
                game.draw();
            }

            function info(){

                var str = 'Setup phase:\n' +
                          '- drag ships to place them\n' + 
                          '- click on a ship will flip its orientation\n' +
                          '- click on the field will randomly place all ships\n' +
                          '- click on your board outside of the field means you finished setting up ships\n\n' +
                          'Play phase:\n' +
                          '- just go ahead shooting around on the opponents field\n\n' + 
                          'The single modes are there as benchmarks and for development and training of the AI.\n\n' + 
                          'Build by:\n@stehrenberg\n@chanton1392\n@abstractCalculus\n@benjaminaaron\n\n' + 
                          'More info at:\nhttps://github.com/benjaminaaron/BattleshipAI';
                alert(str);
            }

            function reset(){
                location.reload();
            }

            function ensure2Digits(content){
                var str = '' + content;
                if(str.length == 1)
                    str = '0' + str;
                return str;
            }

            function getFormattedDate() {
                var date = new Date();
                var day = date.getDate();
                var month = (date.getMonth() + 1);
                var year = date.getFullYear();
                var hour = date.getHours();
                var minute = date.getMinutes();
                var second = date.getSeconds();           
                return ensure2Digits(day) + '.' + ensure2Digits(month) + '.' + ensure2Digits(year) + ' ' + ensure2Digits(hour) + ':' + ensure2Digits(minute) + ':' + ensure2Digits(second);
            }

            var HighscoreEntry = function(player0, player1, winnerIndex, shots, timestamp){
                this.player0 = player0;
                this.player1 = player1;
                this.winner = winnerIndex == 0 ? player0 : player1;
                this.looser = winnerIndex == 0 ? player1 : player0;
                this.shots = shots;
                this.timestamp = timestamp;
                this.toString = function(){
                    var str = this.timestamp + '&nbsp;&nbsp;&nbsp;&nbsp;<b>' + this.winner + '</b> won against <b>'  + this.looser + '</b> with <b>' + shots + '</b> shots';
                    return str;
                }
            }

            function showHighscore(){
                $('#dialog').dialog('open');
                if(firebase){
                    var highscoreEntries = [];
                    console.log('fetching data from firebase...');

                    firebase.once('value', function(dataSnapshot) {
                        var entries = dataSnapshot.val();
                        for (var indexStr in entries) {
                            if (entries.hasOwnProperty(indexStr)) {
                                var entry  = entries[indexStr];
                                var newHighscoreEntry = new HighscoreEntry(entry.player0, entry.player1, entry.winner, entry.shots, entry.timestamp);
                                highscoreEntries.push(newHighscoreEntry);
                            }
                        }
                        // TODO sort highscoreEntries

                        var table = $('#highscoreTable');
                        table.children().remove();
                        var tr, td;
                        for(var i=0; i < highscoreEntries.length; i++){
                            tr = $('<tr>');
                            table.append(tr);
                            td = $('<td>');
                            tr.append(td);
                            td.append('' + highscoreEntries[i]);
                        }
                    });
                }
            }
/*          
            function debug(){      
                console.log(game.boards[0].ships);
            }                  
            
            $('body').on('keydown', function(e){ 
                if(e.shiftKey && game.activeBoard)  
                    if(game.currentPlayer)
                        if(game.currentPlayer.type == 'human')
                            game.currentPlayer.flipShipsOrientation(false);
                if(e.keyCode == 82) // r
                    if(game.currentPlayer)
                        if(game.currentPlayer.type == 'human')
                            game.currentPlayer.btnCallback('random');
            });
*/
        </script>

    </body> 
</html>
